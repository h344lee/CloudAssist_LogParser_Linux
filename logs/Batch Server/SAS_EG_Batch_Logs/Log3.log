1                                                          The SAS System                            11:47 Wednesday, August 4, 2021

1          ;*';*";*/;quit;run;
2          OPTIONS PAGENO=MIN;
3          %LET _CLIENTTASKLABEL='Assign Promocode';
4          %LET _CLIENTPROCESSFLOWNAME='Process Flow';
5          %LET _CLIENTPROJECTPATH='S:\corp\E-Commerce\Marketing\2021\Email\Targeting code\08 August\08.15\Mystery
5        ! Package\EML_Mystery_Promocode_Assignment_SA_Ran_Successfully.egp';
6          %LET _CLIENTPROJECTPATHHOST='SPC110JR6';
7          %LET _CLIENTPROJECTNAME='EML_Mystery_Promocode_Assignment_SA_Ran_Successfully.egp';
8          %LET _SASPROGRAMFILE='';
9          %LET _SASPROGRAMFILEHOST='';
10         
11         ODS _ALL_ CLOSE;
12         OPTIONS DEV=SVG;
13         GOPTIONS XPIXELS=0 YPIXELS=0;
14         %macro HTML5AccessibleGraphSupported;
15             %if %_SAS_VERCOMP(9, 4, 4) >= 0 %then ACCESSIBLE_GRAPH;
16         %mend;
17         FILENAME EGHTML TEMP;
18         ODS HTML5(ID=EGHTML) FILE=EGHTML
19             OPTIONS(BITMAP_MODE='INLINE')
20             %HTML5AccessibleGraphSupported
21             ENCODING='utf-8'
22             STYLE=HTMLBlue
23             NOGTITLE
24             NOGFOOTNOTE
25             GPATH=&sasworklocation
26         ;
NOTE: Writing HTML5(EGHTML) Body file: EGHTML
27         FILENAME EGSR TEMP;
28         ODS tagsets.sasreport13(ID=EGSR) FILE=EGSR
29             STYLE=HTMLBlue
30             NOGTITLE
31             NOGFOOTNOTE
32             GPATH=&sasworklocation
33             ENCODING=UTF8
34             options(rolap="on")
35         ;
NOTE: Writing TAGSETS.SASREPORT13(EGSR) Body file: EGSR
36         
37         proc sql;
38         connect to netezza
39         (server=pnm00020 database=CIA_UNICA_MART user="&nz_user" password="&nz_pass");
40         
41         execute by netezza(
42         
43         drop table s1 if exists;
44         
45         create temp table s1 as
46         select a.*,
47         case
48         when is_kc = 1 and is_loy = 1 then 'KC_AND_KR'
49         when is_kc = 1 and is_loy = 0 then 'KC_ONLY'
50         WHEN IS_KC = 0 AND IS_LOY = 1 THEN 'KR_ONLY' END AS FLAG,
51         CASE
52         WHEN DISCOUNT = 40 AND FLAG IN ( 'KC_AND_KR','KC_ONLY' ) THEN 'E4_percent_40_KC_KCKR_GC'
53         WHEN DISCOUNT = 40 AND (FLAG ='KR_ONLY' ) THEN 'E4_percent_40_KRewards_GC'
54         WHEN DISCOUNT = 30 AND (FLAG IN ('KC_AND_KR' ,'KC_ONLY' )) THEN 'E4_percent_30_KC_KCKR_GC'
55         WHEN DISCOUNT = 30 AND (FLAG = 'KR_ONLY' ) THEN 'E4_percent_30_KRewards_GC'
2                                                          The SAS System                            11:47 Wednesday, August 4, 2021

56         WHEN DISCOUNT = 20 AND (FLAG IN ('KC_AND_KR','KC_ONLY' )) THEN 'E4_percent_20_KC_KCKR_GC'
57         WHEN DISCOUNT = 20 AND (FLAG = 'KR_ONLY' ) THEN 'E4_percent_20_KRewards_GC'
58         END AS E4
59         from
60         &SNT. a
61         where
62         a.OPT_IN in ('SA')
63         distribute on (email_stdz);
64         
65         generate statistics on s1;
66         
67         drop table percent_40_KC_KCKR_GC if exists;
68         
69         create temp table percent_40_KC_KCKR_GC as
70         select
71         s1.EMAIL_MASTER_KEY, s1.email_stdz, s1.opt_in, s1.test_control, s1.is_kc, s1.is_loy, s1.discount, s1.e4,x1.promocode,
71       ! x1.event_id
72         from s1  left join
73         (
74         select y.*, b.promocode, b.event_id from
75         (
76         SELECT x.*,  row_number() over(order by random()) AS rnk
77         FROM
78         	(
79         	select
80         	distinct email_stdz, discount, e4
81         	from s1 a where e4 = 'E4_percent_40_KC_KCKR_GC'
82         	) x
83         ) y
84         inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'SA_40_KC'
85         ) x1 on x1.email_stdz = s1.email_stdz
86         where s1.e4 = 'E4_percent_40_KC_KCKR_GC'
87         ;
88         
89         drop table percent_40_KRewards_GC if exists;
90         
91         create temp table percent_40_KRewards_GC as
92         select
93         s1.EMAIL_MASTER_KEY, s1.email_stdz, s1.opt_in, s1.test_control, s1.is_kc, s1.is_loy, s1.discount, s1.e4,x1.promocode,
93       ! x1.event_id
94         from s1  left join
95         (
96         select y.*, b.promocode, b.event_id from
97         (
98         SELECT x.*,  row_number() over(order by random()) AS rnk
99         FROM
100        	(
101        	select
102        	distinct email_stdz, discount, e4
103        	from s1 a where e4 = 'E4_percent_40_KRewards_GC'
104        	
105        	) x
106        ) y
107        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'SA_40_NKC'
108        ) x1 on x1.email_stdz = s1.email_stdz
109        where s1.e4 = 'E4_percent_40_KRewards_GC'
110        ;
111        
3                                                          The SAS System                            11:47 Wednesday, August 4, 2021

112        
113        drop table percent_30_KC_KCKR_GC if exists;
114        
115        create temp table percent_30_KC_KCKR_GC as
116        select
117        s1.EMAIL_MASTER_KEY, s1.email_stdz, s1.opt_in, s1.test_control, s1.is_kc, s1.is_loy, s1.discount, s1.e4,x1.promocode,
117      ! x1.event_id
118        from s1  left  join
119        (
120        select y.*, b.promocode, b.event_id from
121        (
122        SELECT x.*,  row_number() over(order by random()) AS rnk
123        FROM
124        	(
125        	select
126        	distinct email_stdz, discount, e4
127        	from s1 a where e4 = 'E4_percent_30_KC_KCKR_GC'
128        	
129        	) x
130        ) y
131        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'SA_30_KC'
132        ) x1 on x1.email_stdz = s1.email_stdz
133        where s1.e4 = 'E4_percent_30_KC_KCKR_GC'
134        ;
135        
136        
137        
138        drop table percent_30_KRewards_GC if exists;
139        
140        create temp table percent_30_KRewards_GC as
141        select s1.EMAIL_MASTER_KEY, s1.email_stdz, s1.opt_in, s1.test_control, s1.is_kc, s1.is_loy, s1.discount,
141      ! s1.e4,x1.promocode, x1.event_id
142        from s1  left  join
143        (
144        select y.*, b.promocode, b.event_id from
145        (
146        SELECT x.*,  row_number() over(order by random()) AS rnk
147        FROM
148        	(
149        	select
150        	distinct email_stdz, discount, e4
151        	from s1 a where e4 = 'E4_percent_30_KRewards_GC'
152        
153        	) x
154        ) y
155        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'SA_30_NKC'
156        ) x1 on x1.email_stdz = s1.email_stdz
157        where s1.e4 = 'E4_percent_30_KRewards_GC'
158        ;
159        
160        
161        drop table percent_20_KC_KCKR_GC if exists;
162        
163        create temp table percent_20_KC_KCKR_GC as
164        select s1.EMAIL_MASTER_KEY, s1.email_stdz, s1.opt_in, s1.test_control, s1.is_kc, s1.is_loy, s1.discount,
164      ! s1.e4,x1.promocode, x1.event_id
165        from s1  left  join (
166        select y.*, b.promocode, b.event_id from
4                                                          The SAS System                            11:47 Wednesday, August 4, 2021

167        (
168        SELECT x.*,  row_number() over(order by random()) AS rnk
169        FROM
170        	(
171        	select
172        	distinct email_stdz, discount, e4
173        	from s1 a where e4 = 'E4_percent_20_KC_KCKR_GC'
174        	
175        	) x
176        ) y
177        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'SA_20_KC'
178        ) x1 on x1.email_stdz = s1.email_stdz
179        where s1.e4 = 'E4_percent_20_KC_KCKR_GC'
180        ;
181        
182        drop table percent_20_KRewards_GC if exists;
183        
184        create temp table percent_20_KRewards_GC as
185        select s1.EMAIL_MASTER_KEY, s1.email_stdz, s1.opt_in, s1.test_control, s1.is_kc, s1.is_loy, s1.discount,
185      ! s1.e4,x1.promocode, x1.event_id
186        from s1  left  join
187        (
188        select y.*, b.promocode, b.event_id from
189        (
190        SELECT x.*,  row_number() over(order by random()) AS rnk
191        FROM
192        	(
193        	select
194        	distinct email_stdz, discount, e4
195        	from s1 a where e4 = 'E4_percent_20_KRewards_GC'
196        
197        	) x
198        ) y
199        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'SA_20_NKC'
200        ) x1 on x1.email_stdz = s1.email_stdz
201        where s1.e4 = 'E4_percent_20_KRewards_GC'
202        ;
203        
204        
205        drop table sa if exists;
206        
207        create temp table sa as
208        select * from percent_20_KC_KCKR_GC
209        union
210        select * from percent_20_KRewards_GC
211        union
212        select * from percent_30_KC_KCKR_GC
213        union
214        select * from percent_30_KRewards_GC
215        union
216        select * from percent_40_KC_KCKR_GC
217        union
218        select * from percent_40_KRewards_GC
219        ;
220        
221        
222        drop table s2 if exists;
223        
5                                                          The SAS System                            11:47 Wednesday, August 4, 2021

224        create temp table s2 as
225        select a.*,
226        case
227        when is_kc = 1 THEN 'KC'
228        WHEN IS_KC = 0 THEN 'NONKC' END AS FLAG,
229        
230        CASE
231        WHEN DISCOUNT = 40 AND FLAG = 'KC' THEN 'E4_40KRewards'
232        WHEN DISCOUNT = 40 AND FLAG = 'NONKC' THEN 'E4_40NonKCKR'
233        
234        WHEN DISCOUNT = 30 AND FLAG = 'KC' THEN 'E4_30KRewards'
235        WHEN DISCOUNT = 30 AND FLAG = 'NONKC' THEN 'E4_30NonKCKR'
236        
237        WHEN DISCOUNT = 20 AND FLAG = 'KC' THEN 'E4_20KRewards'
238        WHEN DISCOUNT = 20 AND FLAG = 'NONKC' THEN 'E4_20NonKCKR'
239        end as E4
240        from
241        &SNT. a
242        where
243        a.OPT_IN in ('KR_MYST')
244        distribute on (email_master_key);
245        generate statistics on s2;
246        
247        
248        
249        drop table KRewards_20 if exists;
250        
251        create temp table KRewards_20 as
252        select s2.EMAIL_MASTER_KEY, s2.email_stdz, s2.opt_in, s2.test_control, s2.is_kc, s2.is_loy, s2.discount,
252      ! s2.e4,x1.promocode, x1.event_id
253        from s2  left  join
254        (
255        select y.*, b.promocode, b.event_id from
256        (
257        SELECT x.*,  row_number() over(order by random()) AS rnk
258        FROM
259        	(
260        	select
261        	distinct email_stdz, discount, E4
262        	from s2 a where e4 = 'E4_20KRewards'
263        	
264        	) x
265        ) y
266        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'KR_20_KC'
267        ) x1 on x1.email_stdz = s2.email_stdz
268        where s2.e4 = 'E4_20KRewards'
269        ;
270        
271        
272        drop table NonKCKR_20 if exists;
273        
274        create temp table NonKCKR_20 as
275        select s2.EMAIL_MASTER_KEY, s2.email_stdz, s2.opt_in, s2.test_control, s2.is_kc, s2.is_loy, s2.discount,
275      ! s2.e4,x1.promocode, x1.event_id
276        from s2  left join
277        (
278        select y.*, b.promocode, b.event_id from
279        (
6                                                          The SAS System                            11:47 Wednesday, August 4, 2021

280        SELECT x.*,  row_number() over(order by random()) AS rnk
281        FROM
282        	(
283        	select
284        	distinct email_stdz, discount, E4
285        	from s2 a where e4 = 'E4_20NonKCKR'
286        
287        	) x
288        ) y
289        inner join EML_MYSTERY_PROMO  b on y.rnk = b.row_num where b.flg = 'KR_20_NKC'
290        ) x1 on x1.email_stdz = s2.email_stdz
291        where s2.e4 = 'E4_20NonKCKR'
292        ;
293        
294        
295        drop table KRewards_30 if exists;
296        create temp table KRewards_30 as
297        select s2.EMAIL_MASTER_KEY, s2.email_stdz, s2.opt_in, s2.test_control, s2.is_kc, s2.is_loy, s2.discount,
297      ! s2.e4,x1.promocode, x1.event_id
298        from s2  left outer join
299        (
300        select y.*, b.promocode, b.event_id from
301        (
302        SELECT x.*,  row_number() over(order by random()) AS rnk
303        FROM
304        	(
305        	select
306        	distinct email_stdz, discount, E4
307        	from s2 a where e4 = 'E4_30KRewards'
308        
309        	) x
310        ) y
311        inner join EML_MYSTERY_PROMO  b on y.rnk = b.row_num where b.flg = 'KR_30_KC'
312        ) x1 on x1.email_stdz = s2.email_stdz
313        where s2.e4 = 'E4_30KRewards'
314        ;
315        
316        
317        drop table NonKCKR_30 if exists;
318        
319        create temp table NonKCKR_30 as
320        select s2.EMAIL_MASTER_KEY, s2.email_stdz, s2.opt_in, s2.test_control, s2.is_kc, s2.is_loy, s2.discount,
320      ! s2.e4,x1.promocode, x1.event_id
321        from s2  left outer join
322        (
323        select y.*, b.promocode, b.event_id from
324        (
325        SELECT x.*,  row_number() over(order by random()) AS rnk
326        FROM
327        	(
328        	select
329        	distinct email_stdz, discount, E4
330        	from s2 a where e4 = 'E4_30NonKCKR'
331        
332        	) x
333        ) y
334        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'KR_30_NKC'
335        ) x1 on x1.email_stdz = s2.email_stdz
7                                                          The SAS System                            11:47 Wednesday, August 4, 2021

336        where s2.e4 = 'E4_30NonKCKR'
337        ;
338        
339        
340        drop table KRewards_40 if exists;
341        
342        create temp table KRewards_40 as
343        select s2.EMAIL_MASTER_KEY, s2.email_stdz, s2.opt_in, s2.test_control, s2.is_kc, s2.is_loy, s2.discount,
343      ! s2.e4,x1.promocode, x1.event_id
344        from s2  left outer join
345        (
346        select y.*, b.promocode, b.event_id from
347        (
348        SELECT x.*,  row_number() over(order by random()) AS rnk
349        FROM
350        	(
351        	select
352        	distinct email_stdz, discount, E4
353        	from s2 a where e4 = 'E4_40KRewards'
354        
355        	) x
356        ) y
357        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'KR_40_KC'
358        ) x1 on x1.email_stdz = s2.email_stdz
359        where s2.e4 = 'E4_40KRewards'
360        ;
361        
362        drop table NonKCKR_40 if exists;
363        
364        create temp table NonKCKR_40 as
365        select s2.EMAIL_MASTER_KEY, s2.email_stdz, s2.opt_in, s2.test_control, s2.is_kc, s2.is_loy, s2.discount,
365      ! s2.e4,x1.promocode, x1.event_id
366        from s2  left outer join
367        (
368        select y.*, b.promocode, b.event_id from
369        (
370        SELECT x.*,  row_number() over(order by random()) AS rnk
371        FROM
372        	(
373        	select
374        	distinct email_stdz, discount, E4
375        	from s2 a where e4 = 'E4_40NonKCKR'
376        
377        	) x
378        ) y
379        inner join EML_MYSTERY_PROMO  b on y.rnk = b.row_num where b.flg = 'KR_40_NKC'
380        ) x1 on x1.email_stdz = s2.email_stdz
381        where s2.e4 = 'E4_40NonKCKR'
382        ;
383        
384        
385        DROP TABLE KR IF EXISTS;
386        CREATE TEMP TABLE KR AS
387        SELECT * FROM KRewards_20
388        UNION
389        SELECT * FROM NonKCKR_20
390        UNION
391        SELECT * FROM KRewards_30
8                                                          The SAS System                            11:47 Wednesday, August 4, 2021

392        UNION
393        SELECT * FROM NonKCKR_30
394        UNION
395        SELECT * FROM KRewards_40
396        UNION
397        SELECT * FROM NonKCKR_40
398        ;
399        
400        
401        
402        drop table MERGED_SA_KR if exists;
403        CREATE temp TABLE MERGED_SA_KR AS
404        SELECT email_master_key, EMAIL_STDZ, OPT_IN, test_control, IS_KC, IS_LOY, DISCOUNT, e4,  PROMOCODE, EVENT_ID FROM SA
405        UNION
406        SELECT email_master_key, EMAIL_STDZ, OPT_IN, test_control, IS_KC, IS_LOY, DISCOUNT, E4, PROMOCODE, EVENT_ID FROM KR
407        ;
408        
409        
410        
411        drop table L1 if exists;
412        
413        create temp table L1 as
414        select a.*,
415        case
416        when is_kc = 1 and is_loy = 1 then 'KC_AND_KR'
417        when is_kc = 1 and is_loy = 0 then 'KC_ONLY'
418        WHEN IS_KC = 0 AND IS_LOY = 1 THEN 'KR_ONLY' END AS FLAG,
419        
420        CASE
421        WHEN DISCOUNT = 40 AND FLAG IN ( 'KC_AND_KR','KC_ONLY' ) THEN 'E4_percent_40_KC_KCKR_GC'
422        WHEN DISCOUNT = 40 AND (FLAG ='KR_ONLY' ) THEN 'E4_percent_40_KRewards_GC'
423        WHEN DISCOUNT = 30 AND (FLAG IN ('KC_AND_KR' ,'KC_ONLY' )) THEN 'E4_percent_30_KC_KCKR_GC'
424        WHEN DISCOUNT = 30 AND (FLAG = 'KR_ONLY' ) THEN 'E4_percent_30_KRewards_GC'
425        WHEN DISCOUNT = 20 AND (FLAG IN ('KC_AND_KR','KC_ONLY' )) THEN 'E4_percent_20_KC_KCKR_GC'
426        WHEN DISCOUNT = 20 AND (FLAG = 'KR_ONLY' ) THEN 'E4_percent_20_KRewards_GC'
427        END AS E4
428        from
429        &SNT. a
430        where
431        a.OPT_IN in ('LIMITED')
432        distribute on (email_master_key);
433        generate statistics on L1;
434        
435        
436        
437        
438        
439        drop table percent_20_KC_KCKR_GC_LTD if exists;
440        
441        create temp table percent_20_KC_KCKR_GC_LTD as
442        select L1.email_master_key, L1.EMAIL_STDZ, L1.OPT_IN, L1.TEST_CONTROL, L1.IS_KC, L1.IS_LOY,  L1.DISCOUNT, L1.FLAG, L1.E4,
442      !   promocode, event_id
443        from L1  left outer join
444        (
445        select y.*, b.promocode, b.event_id from
446        (
447        SELECT x.*,  row_number() over(order by random()) AS rnk
448        FROM
9                                                          The SAS System                            11:47 Wednesday, August 4, 2021

449        	(
450        	select
451        	distinct email_stdz, discount, e4
452        	from L1 a where e4 = 'E4_percent_20_KC_KCKR_GC'
453        	
454        	) x
455        ) y
456        inner join EML_mystery_promo b on y.rnk = b.row_num where b.flg = 'LT_20_KC'
457        ) x1 on x1.email_stdz = L1.email_stdz
458        where L1.e4 = 'E4_percent_20_KC_KCKR_GC'
459        ;
460        
461        
462        drop table percent_20_KRewards_GC_LTD if exists;
463        
464        create temp table percent_20_KRewards_GC_LTD as
465        select L1.email_master_key, L1.EMAIL_STDZ, L1.OPT_IN, L1.TEST_CONTROL, L1.IS_KC, L1.IS_LOY,  L1.DISCOUNT, L1.FLAG, L1.E4,
465      !  promocode, event_id
466        from L1  left outer join
467        (
468        select y.*, b.promocode, b.event_id from
469        (
470        SELECT x.*,  row_number() over(order by random()) AS rnk
471        FROM
472        	(
473        	select
474        	distinct email_stdz, discount, e4
475        	from L1 a where e4 = 'E4_percent_20_KRewards_GC'
476        
477        	) x
478        ) y
479        inner join EML_mystery_promo b on y.rnk = b.row_num where b.flg = 'LT_20_NKC'
480        ) x1 on x1.email_stdz = L1.email_stdz
481        where L1.e4 = 'E4_percent_20_KRewards_GC'
482        ;
483        
484        drop table percent_30_KC_KCKR_GC_LTD if exists;
485        
486        create temp table percent_30_KC_KCKR_GC_LTD as
487        select L1.email_master_key, L1.EMAIL_STDZ, L1.OPT_IN, L1.TEST_CONTROL, L1.IS_KC, L1.IS_LOY,  L1.DISCOUNT, L1.FLAG, L1.E4,
487      !  promocode, event_id
488        from L1  left outer join
489        (
490        select y.*, b.promocode, b.event_id from
491        (
492        SELECT x.*,  row_number() over(order by random()) AS rnk
493        FROM
494        	(
495        	select
496        	distinct email_stdz, discount, e4
497        	from L1 a where e4 = 'E4_percent_30_KC_KCKR_GC'
498        
499        	) x
500        ) y
501        inner join eml_mystery_promo b on y.rnk = b.row_num where b.flg = 'LT_30_KC'
502        ) x1 on x1.email_stdz = L1.email_stdz
503        where L1.e4 = 'E4_percent_30_KC_KCKR_GC'
504        ;
10                                                         The SAS System                            11:47 Wednesday, August 4, 2021

505        
506        drop table percent_30_KRewards_GC_LTD if exists;
507        
508        create temp table percent_30_KRewards_GC_LTD as
509        select L1.email_master_key, L1.EMAIL_STDZ, L1.OPT_IN, L1.TEST_CONTROL, L1.IS_KC, L1.IS_LOY,  L1.DISCOUNT, L1.FLAG, L1.E4,
509      !   promocode, event_id
510        from L1  left outer join
511        (
512        select y.*, b.promocode, b.event_id from
513        (
514        SELECT x.*,  row_number() over(order by random()) AS rnk
515        FROM
516        	(
517        	select
518        	distinct email_stdz, discount, e4
519        	from L1 a where e4 = 'E4_percent_30_KRewards_GC'
520        
521        	) x
522        ) y
523        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'LT_30_NKC'
524        ) x1 on x1.email_stdz = L1.email_stdz
525        where L1.e4 = 'E4_percent_30_KRewards_GC'
526        ;
527        
528        drop table percent_40_KC_KCKR_GC_LTD if exists;
529        
530        create temp table percent_40_KC_KCKR_GC_LTD as
531        select L1.email_master_key, L1.EMAIL_STDZ, L1.OPT_IN, L1.TEST_CONTROL, L1.IS_KC, L1.IS_LOY,  L1.DISCOUNT, L1.FLAG, L1.E4,
531      !  promocode, event_id
532        from L1  left outer join
533        (
534        select y.*, b.promocode, b.event_id from
535        (
536        SELECT x.*,  row_number() over(order by random()) AS rnk
537        FROM
538        	(
539        	select
540        	distinct email_stdz, discount, e4
541        	from L1 a where e4 = 'E4_percent_40_KC_KCKR_GC'
542        
543        	) x
544        ) y
545        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'LT_40_KC'
546        ) x1 on x1.email_stdz = L1.email_stdz
547        where L1.e4 = 'E4_percent_40_KC_KCKR_GC'
548        ;
549        
550        
551        
552        drop table percent_40_KRewards_GC_LTD if exists;
553        
554        create temp table percent_40_KRewards_GC_LTD as
555        select L1.email_master_key, L1.EMAIL_STDZ, L1.OPT_IN, L1.TEST_CONTROL, L1.IS_KC, L1.IS_LOY,  L1.DISCOUNT, L1.FLAG, L1.E4,
555      !  promocode, event_id
556        from L1  left outer join
557        (
558        select y.*, b.promocode, b.event_id from
559        (
11                                                         The SAS System                            11:47 Wednesday, August 4, 2021

560        SELECT x.*,  row_number() over(order by random()) AS rnk
561        FROM
562        	(
563        	select
564        	distinct email_stdz, discount, e4
565        	from L1 a where e4 = 'E4_percent_40_KRewards_GC'
566        
567        	) x
568        ) y
569        inner join EML_MYSTERY_PROMO b on y.rnk = b.row_num where b.flg = 'LT_40_NKC'
570        ) x1 on x1.email_stdz = L1.email_stdz
571        where L1.e4 = 'E4_percent_40_KRewards_GC'
572        ;
573        
574        drop table LMTD if exists;
575        
576        create temp table LMTD as
577        select * from percent_20_KC_KCKR_GC_LTD
578        union
579        select * from percent_20_KRewards_GC_LTD
580        union
581        select * from percent_30_KC_KCKR_GC_LTD
582        union
583        select * from percent_30_KRewards_GC_LTD
584        union
585        select * from percent_40_KC_KCKR_GC_LTD
586        union
587        select * from percent_40_KRewards_GC_LTD
588        ;
589        
590        drop table &final. if exists;
591        create table &final.
592        as
593        select EMAIL_MASTER_KEY, EMAIL_STDZ, OPT_IN, TEST_CONTROL, IS_KC, IS_LOY, DISCOUNT, E4, PROMOCODE, EVENT_ID,
593      ! current_timestamp as insert_time from merged_sa_kr
594        union
595        select EMAIL_MASTER_KEY, EMAIL_STDZ, OPT_IN, TEST_CONTROL, IS_KC,IS_LOY, DISCOUNT, E4, PROMOCODE, EVENT_ID,
595      ! current_timestamp as insert_time   from lmtd
596        distribute on (email_stdz);
597        generate statistics on &final.;
598        );
599        disconnect from netezza;
600        
601        
602        %LET _CLIENTTASKLABEL=;
603        %LET _CLIENTPROCESSFLOWNAME=;
604        %LET _CLIENTPROJECTPATH=;
605        %LET _CLIENTPROJECTPATHHOST=;
606        %LET _CLIENTPROJECTNAME=;
607        %LET _SASPROGRAMFILE=;
608        %LET _SASPROGRAMFILEHOST=;
609        
610        ;*';*";*/;quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           10:47.43
      cpu time            0.02 seconds
      

12                                                         The SAS System                            11:47 Wednesday, August 4, 2021

610      !                run;
611        ODS _ALL_ CLOSE;
612        
613        
614        QUIT; RUN;
615        
